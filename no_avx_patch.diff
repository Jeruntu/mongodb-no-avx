# MongoDB 7.x No-AVX Patch
#
# This patch disables the sandybridge (AVX-requiring) default optimization
# in MongoDB 7.x SCons builds.
#
# MongoDB 7.x uses SCons and controls CPU-specific optimizations via the
# 'experimental-optimization' option in SConstruct. By default, it includes
# '+sandybridge' which sets -march=sandybridge (requiring AVX).
#
# This patch changes the default from ['+sandybridge'] to [] (empty),
# which causes MongoDB to use the generic x86-64 baseline instead.
#
# Why this works:
# - Without sandybridge in selected_experimental_optimizations, the code
#   in SConstruct around line 2720 won't set march=sandybridge
# - Instead, it falls through to the default_alignment_search_sequence
#   which doesn't require AVX
#
# Architecture comparison:
# | -march        | AVX Required | Year | Notes                    |
# |---------------|--------------|------|--------------------------|
# | x86-64        | No           | 2003 | Baseline AMD64/Intel64   |
# | x86-64-v2     | No           | 2008 | Adds SSE4.2, POPCNT      |
# | sandybridge   | Yes (AVX)    | 2011 | MongoDB 7.x default      |
#
--- a/SConstruct
+++ b/SConstruct
@@ -323,7 +323,7 @@ add_option(
     'experimental-optimization',
     action="append",
     choices=experimental_optimization_choices,
     const=experimental_optimization_choices[0],
-    default=['+sandybridge'],
+    default=[],
     help='Enable experimental optimizations',
     nargs='?',
     type='choice',
