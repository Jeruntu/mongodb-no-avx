# Docker Compose for Omada Controller with External MongoDB (no AVX)
# This configuration runs MongoDB externally to the Omada Controller container

services:
  mongodb:
    # Use pre-built image from GHCR
    image: ghcr.io/fenio/mongodb-no-avx:8.0.17
    # Or build locally (uncomment below, comment out image above)
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     MONGO_VERSION: "8.0.17"
    #     NUM_JOBS: ""
    container_name: omada-mongodb
    restart: unless-stopped
    volumes:
      - mongodb-data:/data/db
    networks:
      - omada-network
    # MongoDB configuration for Omada Controller
    command: ["--bind_ip_all", "--port", "27017"]
    healthcheck:
      test: ["CMD", "mongod", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

  omada-controller:
    image: mbentley/omada-controller:6.0
    container_name: omada-controller
    restart: unless-stopped
    stop_grace_period: 60s
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    networks:
      - omada-network
    ports:
      # Management ports
      - "8088:8088"   # HTTP management portal
      - "8043:8043"   # HTTPS management portal
      - "8843:8843"   # HTTPS portal
      # Device communication ports
      - "27001:27001/udp"  # App discovery
      - "29810:29810/udp"  # Device discovery
      - "29811-29817:29811-29817"  # Device management
      - "19810:19810/udp"  # Device management (older firmware)
    environment:
      - TZ=Etc/UTC
      # External MongoDB configuration
      - MONGO_EXTERNAL=true
      - EAP_MONGOD_URI=mongodb://omada-mongodb:27017/omada
    volumes:
      - omada-data:/opt/tplink/EAPController/data
      - omada-logs:/opt/tplink/EAPController/logs
    depends_on:
      mongodb:
        condition: service_healthy

networks:
  omada-network:
    driver: bridge

volumes:
  mongodb-data:
  omada-data:
  omada-logs:
